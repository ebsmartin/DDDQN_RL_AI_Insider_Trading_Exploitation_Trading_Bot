import org.apache.storm.spout.SpoutOutputCollector;
import org.apache.storm.task.TopologyContext;
import org.apache.storm.topology.OutputFieldsDeclarer;
import org.apache.storm.topology.base.BaseRichSpout;
import org.apache.storm.tuple.Fields;
import org.apache.storm.tuple.Values;
import java.util.List;
import java.util.Map;
import com.google.common.util.concurrent.RateLimiter;

import java.net.HttpURLConnection;
import java.net.URL;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.IOException;
import java.net.MalformedURLException;
import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.LocalDateTime;

public class SECDataSpout extends BaseRichSpout {
    private RateLimiter rateLimiter;
    private SpoutOutputCollector collector;
    private List<String> SECData;
    private String header;
    private int index = 0;

    private Boolean hasEnded = false;

    // Get the API key from environment variable
    String API_KEY = System.getenv("API_KEY");

    public SECDataSpout(List<String> SECData, String SECHeader) {
        this.SECData = SECData;
        this.header = SECHeader;
        System.out.println("Length of SEC Historical Data File: " + SECData.size());
    }

    @Override
    public void open(Map conf, TopologyContext context, SpoutOutputCollector collector) {
        this.collector = collector;
        // Create a RateLimiter that allows 50 permits per minute
        // We get 100 requests per minute from the AlphaVantage API
        // We have 2 spouts, so we can make 50 requests per minute per spout
        this.rateLimiter = RateLimiter.create(50.0);
    }

    @Override
    public void nextTuple() {
        if (hasEnded) {
            return;
        }

        if (index >= SECData.size()) {
            // Emit the "END" tuple
            this.collector.emit(new Values("END", "END"));
            hasEnded = true;
            return;
        }

        // Acquire a permit before making an API request
        rateLimiter.acquire();

        // Define stock symbol and time periods
        String[] data = SECData.get(index).split(",");

        String symbol = data[3];  // Stock symbol
        // System.out.println("Stock Symbol: " + symbol);

        // Define date format
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

        // Parse dates
        // System.out.println("Filing Date: " + data[1]);
        LocalDate filingDate = LocalDate.parse(data[1], formatter);

        // grab yyyy-MM from filing date and save as month
        String month = filingDate.toString().substring(0, 7);

        // Define the window for the financial data
        LocalDate windowStart = filingDate.minusDays(3);
        while (windowStart.getDayOfWeek() == DayOfWeek.SATURDAY || windowStart.getDayOfWeek() == DayOfWeek.SUNDAY) {
            windowStart = windowStart.minusDays(1);
        }

        LocalDate windowEnd = windowStart;
        int businessDays = 0;
        while (businessDays < 10) {
            windowEnd = windowEnd.plusDays(1);
            if (windowEnd.getDayOfWeek() != DayOfWeek.SATURDAY && windowEnd.getDayOfWeek() != DayOfWeek.SUNDAY) {
                businessDays++;
            }
        }

        // Check if window spans one or two months
        // For ease of implementation, we will only consider windows that span one month
        boolean doesWindowSpanTwoMonths = windowStart.getMonthValue() != windowEnd.getMonthValue();

        // If window spans two months, we will not make a request
        if (doesWindowSpanTwoMonths) {
            index++;
            return;
        }
        
        // AlphaVantage API parameters
        String interval = "30min"; // The following values are supported: 1min, 5min, 15min, 30min, 60min
        String extendedHours = "false";  // Set to true to include extended hours data
        String dataType = "csv"; // The following values are supported: json, csv

        HttpURLConnection conn = null; // Initialize connection to null

        try {
            // Construct the URL for the AlphaVantage API
            URL url = null;

            url = new URL("https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=" + symbol 
                            + "&interval=" + interval + "&month=" + month + "&extended_hours=" + extendedHours 
                            + "&datatype=" + dataType + "&apikey=" + API_KEY + "&outputsize=full");
                    
            // System.out.println("URL: " + url.toString() + "\n");

            // Open a connection to the URL
            conn = (HttpURLConnection) url.openConnection();

            // Get the response code
            int responseCode = conn.getResponseCode();


            // If the response code is 200 (HTTP_OK), read the response
            if (responseCode == HttpURLConnection.HTTP_OK) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                String inputLine;
                StringBuffer response = new StringBuffer();

                DateTimeFormatter newFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
                boolean isFirstLine = true;  // Flag to check if the current line is the first line (header)

                while ((inputLine = in.readLine()) != null) {
                    // Check if the response contains an error message
                    if (inputLine.contains("Error Message")) {
                        System.out.println("Error in API response: " + inputLine);
                        continue;
                    }

                    // Check if the response contains a date
                    if (!inputLine.matches("\\d{4}-\\d{2}-\\d{2}.*")) {
                        System.out.println("Invalid date in API response: " + inputLine);
                        continue;
                    }

                    // If it's the first line, it's the header. Append it to the response.
                    if (isFirstLine) {
                        response.append(inputLine);
                        response.append("\n"); // adding newline so the csv will be easier to unflatten
                        isFirstLine = false;
                        continue;
                    }else {
                        // Split the line into columns
                        String[] columns = inputLine.split(",");
                        if (columns.length > 0 && columns[0] != null && !columns[0].startsWith("}")) {
                            LocalDateTime timestamp = LocalDateTime.parse(columns[0], newFormatter);
                            // Check if the timestamp falls within the window
                            if (!timestamp.toLocalDate().isBefore(windowStart) && !timestamp.toLocalDate().isAfter(windowEnd)) {
                                response.append(inputLine);
                                response.append("\n"); // adding newline so the csv will be easier to unflatten
                            }
                        } else {
                            System.out.println("Invalid timestamp: " + columns[0]);
                        }
                    }
                }
                in.close();

                // Convert the response stream into a string
                String csvResponse = response.toString();

                // System.out.println(header + "\n" + SECData.get(index) + "\n");
                // System.out.println(csvResponse + "\n");
                // Emit the SEC data row and the financial data csv flattened string
                this.collector.emit(new Values(header + "\n" + SECData.get(index), csvResponse));
            } else {
                System.out.println("GET request not worked");
            }

        } catch (MalformedURLException e) {
            System.out.println("Invalid URL: " + e.getMessage());
        } catch (IOException e) {
            System.out.println("Error reading from the URL: " + e.getMessage());
        } finally {
            if (conn != null) {
                conn.disconnect();
            }
        }

        index++;
    }

    @Override
    public void declareOutputFields(OutputFieldsDeclarer declarer) {
        declarer.declare(new Fields("Header_n_SEC_data", "financial_data"));
    }
}

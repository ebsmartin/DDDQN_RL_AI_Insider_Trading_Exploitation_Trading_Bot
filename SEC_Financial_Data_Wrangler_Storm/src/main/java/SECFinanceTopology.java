import org.apache.storm.Config;
import org.apache.storm.StormSubmitter;
import org.apache.storm.topology.TopologyBuilder;
import org.apache.storm.tuple.Fields;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.List;
import java.nio.file.Path;


public class SECFinanceTopology {

    public static void main(String[] args) throws Exception {

        Path inputPath = Paths.get("/s/chopin/l/grad/ebmartin/cs535/Term_Project/DDDQN_RL_AI_Insider_Trading_Exploitation_Trading_Bot/DDDQ_RL_Trading_Bot/Datasets/toy_dataset.csv");
        System.out.println(inputPath.toString());

        // Read the header of the CSV file
        String header = "";
        try (BufferedReader br = new BufferedReader(new FileReader(inputPath.toString()))) {
            header = br.readLine();
        } catch (IOException e) {
            e.printStackTrace();
        }
        System.out.println("Header: " + header);
      
        // Read SEC data row by row from the CSV file
        List<String> SECData = new ArrayList<>();
        Files.lines(inputPath).forEach(SECData::add);

        // Split the zip codes into two parts so that each spout gets half of the zip codes
        List<String> SECData_part_1 = new ArrayList<>(SECData.subList(1, SECData.size()/2)); // ignore header
        List<String> SECData_part_2 = new ArrayList<>(SECData.subList(SECData.size()/2, SECData.size()));

        // Setup topology
        TopologyBuilder builder = new TopologyBuilder();
        // Set up the spouts
        builder.setSpout("SECDataSpout_1", new SECDataSpout(SECData_part_1, header));
        builder.setSpout("SECDataSpout_2", new SECDataSpout(SECData_part_2, header));

        // Set up the bolts
        // these bolts will be responsible for performing feature engineering on the financial data and emitting the data
        builder.setBolt("CollectingBolt_1", new CollectingBolt()).fieldsGrouping("SECDataSpout_1", new Fields("Header_n_SEC_data", "financial_data"));
        builder.setBolt("CollectingBolt_2", new CollectingBolt()).fieldsGrouping("SECDataSpout_2", new Fields("Header_n_SEC_data", "financial_data"));

        // Set up a bolt for handling the "END" tuple
        // builder.setBolt("EndBolt", new EndBolt()).globalGrouping("SECDataSpout_1");
        builder.setBolt("EndBolt", new EndBolt()).globalGrouping("SECDataSpout_1").globalGrouping("SECDataSpout_2");

        Config conf = new Config();
        conf.setDebug(true);

        conf.setNumWorkers(6);
        StormSubmitter.submitTopology(args[0], conf, builder.createTopology());

    }

    // storm jar target/SEC_Financial_Data-1.0-jar-with-dependencies.jar SECFinanceTopology SEC_Topology
}